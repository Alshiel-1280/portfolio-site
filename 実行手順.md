# SSLå°å…¥å¾Œã®403ã‚¨ãƒ©ãƒ¼ä¿®æ­£ - å®Ÿè¡Œæ‰‹é †

## ğŸ“‹ ç¾çŠ¶

- **ã‚µã‚¤ãƒˆURL**: https://sy-ryosuke.site/
- **ã‚¨ãƒ©ãƒ¼**: 403 Forbidden
- **åŸå› **: Certbotã«ã‚ˆã‚‹è‡ªå‹•è¨­å®šã§Nginxã®ãƒ—ãƒ­ã‚­ã‚·è¨­å®šãŒå¤±ã‚ã‚ŒãŸ

## ğŸ¯ ä»Šã™ãå®Ÿè¡Œã™ã¹ãæ‰‹é †

### æ–¹æ³•1: è‡ªå‹•ä¿®æ­£ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’ä½¿ã†ï¼ˆæ¨å¥¨ãƒ»æœ€é€Ÿ5åˆ†ï¼‰

#### 1. ãƒ­ãƒ¼ã‚«ãƒ«ã‹ã‚‰ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰

```bash
# ãƒ­ãƒ¼ã‚«ãƒ«ãƒã‚·ãƒ³ã§å®Ÿè¡Œï¼ˆMacã®ã‚¿ãƒ¼ãƒŸãƒŠãƒ«ï¼‰
cd /Users/ryo1280/cursor/portfolio-site
scp fix-ssl-403.sh diagnose.sh portfolio-admin@your-server-ip:/home/portfolio-admin/
```

**æ³¨æ„**: `your-server-ip` ã‚’å®Ÿéš›ã®ã‚µãƒ¼ãƒãƒ¼IPã‚¢ãƒ‰ãƒ¬ã‚¹ã«ç½®ãæ›ãˆã¦ãã ã•ã„ã€‚

#### 2. ã‚µãƒ¼ãƒãƒ¼ã«SSHæ¥ç¶š

```bash
ssh portfolio-admin@your-server-ip
```

#### 3. ã‚¹ã‚¯ãƒªãƒ—ãƒˆã«å®Ÿè¡Œæ¨©é™ã‚’ä»˜ä¸

```bash
chmod +x ~/fix-ssl-403.sh
chmod +x ~/diagnose.sh
```

#### 4. è‡ªå‹•ä¿®æ­£ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’å®Ÿè¡Œ

```bash
./fix-ssl-403.sh
```

ã“ã®ã‚¹ã‚¯ãƒªãƒ—ãƒˆãŒè‡ªå‹•çš„ã«ä»¥ä¸‹ã‚’å®Ÿè¡Œã—ã¾ã™ï¼š
- âœ… PM2ã¨Next.jsã®å‹•ä½œç¢ºèª
- âœ… Nginxè¨­å®šã®ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—
- âœ… æ­£ã—ã„ãƒ—ãƒ­ã‚­ã‚·è¨­å®šã®é©ç”¨
- âœ… Nginxã®å†èµ·å‹•
- âœ… å‹•ä½œç¢ºèª

#### 5. ãƒ–ãƒ©ã‚¦ã‚¶ã§ç¢ºèª

https://sy-ryosuke.site/ ã«ã‚¢ã‚¯ã‚»ã‚¹ã—ã¦ã€ã‚µã‚¤ãƒˆãŒè¡¨ç¤ºã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèªã€‚

---

### æ–¹æ³•2: æ‰‹å‹•ã§ä¿®æ­£ã™ã‚‹ï¼ˆ15åˆ†ï¼‰

#### 1. ã‚µãƒ¼ãƒãƒ¼ã«SSHæ¥ç¶š

```bash
ssh portfolio-admin@your-server-ip
```

#### 2. ç¾åœ¨ã®çŠ¶æ³ã‚’ç¢ºèª

```bash
# PM2ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ç¢ºèª
pm2 status

# Next.jsãŒå‹•ä½œã—ã¦ã„ã‚‹ã‹ç¢ºèª
curl http://localhost:3000

# Nginxè¨­å®šã‚’ç¢ºèª
sudo cat /etc/nginx/sites-available/portfolio
```

#### 3. ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚’ä½œæˆ

```bash
sudo cp /etc/nginx/sites-available/portfolio /etc/nginx/sites-available/portfolio.backup.$(date +%Y%m%d)
```

#### 4. Nginxè¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç·¨é›†

```bash
sudo nano /etc/nginx/sites-available/portfolio
```

#### 5. ä»¥ä¸‹ã®å†…å®¹ã«å®Œå…¨ã«ç½®ãæ›ãˆ

```nginx
# HTTPã‹ã‚‰HTTPSã¸ã®ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ
server {
    listen 80;
    listen [::]:80;
    server_name sy-ryosuke.site www.sy-ryosuke.site;

    location /.well-known/acme-challenge/ {
        root /var/www/html;
    }

    location / {
        return 301 https://$server_name$request_uri;
    }
}

# HTTPSè¨­å®š
server {
    listen 443 ssl http2;
    listen [::]:443 ssl http2;
    server_name sy-ryosuke.site www.sy-ryosuke.site;

    # SSLè¨¼æ˜æ›¸
    ssl_certificate /etc/letsencrypt/live/sy-ryosuke.site/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/sy-ryosuke.site/privkey.pem;
    include /etc/letsencrypt/options-ssl-nginx.conf;
    ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem;

    # Next.jsã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã¸ã®ãƒ—ãƒ­ã‚­ã‚·è¨­å®š
    location / {
        proxy_pass http://localhost:3000;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_bypass $http_upgrade;

        # ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆè¨­å®š
        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
    }

    # é™çš„ãƒ•ã‚¡ã‚¤ãƒ«ã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥è¨­å®š
    location /_next/static {
        proxy_cache_valid 60m;
        proxy_pass http://localhost:3000;
    }

    # ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ˜ãƒƒãƒ€ãƒ¼
    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header X-XSS-Protection "1; mode=block" always;
}
```

#### 6. ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä¿å­˜

- `Ctrl + O` â†’ Enterï¼ˆä¿å­˜ï¼‰
- `Ctrl + X`ï¼ˆçµ‚äº†ï¼‰

#### 7. Nginxè¨­å®šã®ãƒ†ã‚¹ãƒˆ

```bash
sudo nginx -t
```

ã€Œtest is successfulã€ã¨è¡¨ç¤ºã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèªã€‚

#### 8. Nginxã‚’å†èµ·å‹•

```bash
sudo systemctl restart nginx
```

#### 9. PM2ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ç¢ºèªã¨å†èµ·å‹•ï¼ˆå¿…è¦ã«å¿œã˜ã¦ï¼‰

```bash
# ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ç¢ºèª
pm2 status

# ã‚ªãƒ³ãƒ©ã‚¤ãƒ³ã§ãªã„å ´åˆã¯å†èµ·å‹•
pm2 restart portfolio

# ãã‚Œã§ã‚‚ãƒ€ãƒ¡ãªã‚‰
pm2 delete portfolio
cd /var/www/portfolio-site
pm2 start npm --name "portfolio" -- start
pm2 save
```

#### 10. å‹•ä½œç¢ºèª

```bash
# HTTPSã‚¢ã‚¯ã‚»ã‚¹ã®ãƒ†ã‚¹ãƒˆ
curl -I https://sy-ryosuke.site
```

ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚³ãƒ¼ãƒ‰ `HTTP/2 200` ãŒè¿”ã£ã¦ãã‚Œã°OKã€‚

#### 11. ãƒ–ãƒ©ã‚¦ã‚¶ã§ç¢ºèª

https://sy-ryosuke.site/ ã«ã‚¢ã‚¯ã‚»ã‚¹ã—ã¦ã€ã‚µã‚¤ãƒˆãŒè¡¨ç¤ºã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèªã€‚

---

## ğŸ” ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°

### å•é¡Œ: Nginxã®ãƒ†ã‚¹ãƒˆãŒå¤±æ•—ã™ã‚‹

```bash
# è©³ç´°ãªã‚¨ãƒ©ãƒ¼ã‚’ç¢ºèª
sudo nginx -t

# æ§‹æ–‡ã‚¨ãƒ©ãƒ¼ãŒã‚ã‚Œã°ã€è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã‚’å†ç¢ºèª
sudo nano /etc/nginx/sites-available/portfolio
```

### å•é¡Œ: 502 Bad Gateway ã‚¨ãƒ©ãƒ¼ãŒå‡ºã‚‹

```bash
# Next.jsã‚¢ãƒ—ãƒªãŒèµ·å‹•ã—ã¦ã„ãªã„
pm2 logs portfolio

# PM2ã‚’å†èµ·å‹•
pm2 restart portfolio
```

### å•é¡Œ: SSLè¨¼æ˜æ›¸ã®ã‚¨ãƒ©ãƒ¼ãŒå‡ºã‚‹

```bash
# è¨¼æ˜æ›¸ã®å­˜åœ¨ç¢ºèª
sudo ls -la /etc/letsencrypt/live/sy-ryosuke.site/

# è¨¼æ˜æ›¸ã®å†å–å¾—
sudo certbot --nginx -d sy-ryosuke.site -d www.sy-ryosuke.site --force-renewal
```

### å•é¡Œ: ãƒãƒ¼ãƒˆ3000ãŒä½¿ãˆãªã„

```bash
# ãƒãƒ¼ãƒˆã‚’ä½¿ç”¨ã—ã¦ã„ã‚‹ãƒ—ãƒ­ã‚»ã‚¹ã‚’ç¢ºèª
sudo lsof -i :3000

# ä¸è¦ãªãƒ—ãƒ­ã‚»ã‚¹ã‚’çµ‚äº†
sudo kill -9 <PID>
```

---

## âœ… æœ€çµ‚ç¢ºèªãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ

ä½œæ¥­å®Œäº†å¾Œã€ä»¥ä¸‹ã‚’ã™ã¹ã¦ç¢ºèªã—ã¦ãã ã•ã„ï¼š

- [ ] `pm2 status` ã§ã‚¢ãƒ—ãƒªãŒ `online` ã«ãªã£ã¦ã„ã‚‹
- [ ] `curl http://localhost:3000` ã§HTMLãŒè¿”ã£ã¦ãã‚‹
- [ ] `sudo nginx -t` ã§ã€Œtest is successfulã€ãŒè¡¨ç¤ºã•ã‚Œã‚‹
- [ ] `sudo systemctl status nginx` ã§ã€Œactive (running)ã€ãŒè¡¨ç¤ºã•ã‚Œã‚‹
- [ ] `curl -I https://sy-ryosuke.site` ã§ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹200ãŒè¿”ã‚‹
- [ ] ãƒ–ãƒ©ã‚¦ã‚¶ã§ https://sy-ryosuke.site ã«ã‚¢ã‚¯ã‚»ã‚¹ã§ãã‚‹
- [ ] SSLè¨¼æ˜æ›¸ã®éµãƒãƒ¼ã‚¯ãŒè¡¨ç¤ºã•ã‚Œã‚‹

---

## ğŸ“Š è¨ºæ–­ã‚³ãƒãƒ³ãƒ‰ï¼ˆå•é¡ŒãŒè§£æ±ºã—ãªã„å ´åˆï¼‰

```bash
# ç·åˆè¨ºæ–­ï¼ˆè¨ºæ–­ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’å®Ÿè¡Œï¼‰
./diagnose.sh

# ã¾ãŸã¯å€‹åˆ¥ã«ç¢ºèª
pm2 status
pm2 logs portfolio --lines 50
sudo tail -100 /var/log/nginx/error.log
sudo tail -50 /var/log/nginx/access.log
curl http://localhost:3000
curl -I https://sy-ryosuke.site
```

---

## ğŸ“ è¿½åŠ ã‚µãƒãƒ¼ãƒˆ

è©³ç´°ãªãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆï¼š
- [QUICK_FIX.md](./QUICK_FIX.md) - ã‚¯ã‚¤ãƒƒã‚¯ä¿®æ­£ã‚¬ã‚¤ãƒ‰
- [SSL_FIX_GUIDE.md](./SSL_FIX_GUIDE.md) - è©³ç´°ãªãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°
- [DEPLOY.md](./DEPLOY.md) - ãƒ‡ãƒ—ãƒ­ã‚¤æ‰‹é †å…¨ä½“

---

**é‡è¦**: ä½œæ¥­ã‚’é–‹å§‹ã™ã‚‹å‰ã«ã€å¿…ãšã‚µãƒ¼ãƒãƒ¼ã®IPã‚¢ãƒ‰ãƒ¬ã‚¹ã¨SSHæ¥ç¶šæƒ…å ±ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚

